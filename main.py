import logging
import sqlite3
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
import os
TOKEN = os.environ.get('BOT_TOKEN')

# ===== БАЗА ДАННЫХ =====
DB_PATH = "users.db"

def init_db():
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS user_branches
                 (user_id INTEGER PRIMARY KEY, branches TEXT)''')
    conn.commit()
    conn.close()

def get_user_branches(user_id):
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("SELECT branches FROM user_branches WHERE user_id = ?", (user_id,))
    row = c.fetchone()
    conn.close()
    if row and row[0]:
        return set(row[0].split(','))
    return set()

def save_user_branches(user_id, branches_set):
    branches_str = ','.join(branches_set)
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("REPLACE INTO user_branches (user_id, branches) VALUES (?, ?)",
              (user_id, branches_str))
    conn.commit()
    conn.close()

# ===== УСЛОВИЯ: для каждой ветви несколько вариантов ключевых слов =====
# Каждый вариант — список слов, которые ДОЛЖНЫ присутствовать в сообщении
CONDITIONS = {
    # Плоть свет
    "плоть_свет": [
        ["обнял", "отражение"],
        ["обняла", "отражение"],
        ["принял", "своё", "отражение"],
        ["приняла", "своё", "отражение"],
        ["слился", "отражением"],
        ["слилась", "отражением"],
        ["обнял", "зеркального", "двойника"],
        ["обняла", "зеркального", "двойника"],
        ["принял", "своего", "двойника"],
        ["приняла", "своего", "двойника"],
    ],
    # Плоть тьма
    "плоть_тьма": [
        ["убил", "все", "отражения"],
        ["убила", "все", "отражения"],
        ["уничтожил", "всех", "копий"],
        ["уничтожила", "всех", "копий"],
        ["перебил", "все", "отражения"],
        ["перебила", "все", "отражения"],
        ["разрушил", "все", "зеркальные", "копии"],
        ["разрушила", "все", "зеркальные", "копии"],
    ],
    # Материя свет
    "материя_свет": [
        ["создал", "артефакт", "чистым", "сердцем"],
        ["создала", "артефакт", "чистым", "сердцем"],
        ["сотворил", "предмет", "силы", "с", "добрыми", "намерениями"],
        ["сотворила", "предмет", "силы", "с", "добрыми", "намерениями"],
        ["выковал", "артефакт", "во", "благо"],
        ["выковала", "артефакт", "во", "благо"],
    ],
    # Материя тьма
    "материя_тьма": [
        ["создал", "артефакт", "ради", "мести"],
        ["создала", "артефакт", "ради", "мести"],
        ["сотворил", "оружие", "для", "отмщения"],
        ["сотворила", "оружие", "для", "отмщения"],
        ["выковал", "артефакт", "из", "ненависти"],
        ["выковала", "артефакт", "из", "ненависти"],
    ],
    # Время свет
    "время_свет": [
        ["наблюдал", "жертву", "магов", "не", "вмешиваясь"],
        ["наблюдала", "жертву", "магов", "не", "вмешиваясь"],
        ["смотрел", "на", "жертвоприношение", "не", "вмешиваясь"],
        ["смотрела", "на", "жертвоприношение", "не", "вмешиваясь"],
        ["не", "вмешался", "в", "ритуал"],
        ["не", "вмешалась", "в", "ритуал"],
    ],
    # Время тьма
    "время_тьма": [
        ["попытался", "изменить", "прошлое"],
        ["попыталась", "изменить", "прошлое"],
        ["вмешался", "в", "ход", "времени"],
        ["вмешалась", "в", "ход", "времени"],
        ["изменил", "прошлое"],
        ["изменила", "прошлое"],
    ],
    # Сны свет
    "сны_свет": [
        ["принял", "свои", "страхи"],
        ["приняла", "свои", "страхи"],
        ["осознал", "свои", "кошмары"],
        ["осознала", "свои", "кошмары"],
        ["перестал", "бояться"],
        ["перестала", "бояться"],
    ],
    # Сны тьма
    "сны_тьма": [
        ["сражался", "со", "страхами"],
        ["сражалась", "со", "страхами"],
        ["победил", "свои", "кошмары", "силой"],
        ["победила", "свои", "кошмары", "силой"],
        ["уничтожил", "свои", "страхи"],
        ["уничтожила", "свои", "страхи"],
    ],
    # Оковы свет
    "оковы_свет": [
        ["честно", "ответил", "на", "вопросы", "судьи"],
        ["честно", "ответила", "на", "вопросы", "судьи"],
        ["признал", "свои", "слабости", "перед", "судьёй"],
        ["признала", "свои", "слабости", "перед", "судьёй"],
    ],
    # Оковы тьма
    "оковы_тьма": [
        ["попытался", "обмануть", "судью"],
        ["попыталась", "обмануть", "судью"],
        ["солгал", "судье"],
        ["солгала", "судье"],
        ["скрыл", "правду", "от", "судьи"],
        ["скрыла", "правду", "от", "судьи"],
    ],
    # Тень свет
    "тень_свет": [
        ["принял", "свою", "тень", "и", "слился", "с", "ней"],
        ["приняла", "свою", "тень", "и", "слилась", "с", "ней"],
        ["обнял", "своего", "теневого", "двойника"],
        ["обняла", "своего", "теневого", "двойника"],
        ["примирился", "со", "своей", "тенью"],
        ["примирилась", "со", "своей", "тенью"],
    ],
    # Тень тьма
    "тень_тьма": [
        ["отверг", "свою", "тень", "и", "победил", "её"],
        ["отвергла", "свою", "тень", "и", "победила", "её"],
        ["убил", "своего", "двойника"],
        ["убила", "своего", "двойника"],
        ["уничтожил", "свою", "тень"],
        ["уничтожила", "свою", "тень"],
    ],
    # Свет свет
    "свет_свет": [
        ["признал", "свои", "грехи", "перед", "светом"],
        ["признала", "свои", "грехи", "перед", "светом"],
        ["покаялся", "в", "своих", "грехах"],
        ["покаялась", "в", "своих", "грехах"],
        ["открыл", "свою", "душу", "свету"],
        ["открыла", "свою", "душу", "свету"],
    ],
    # Свет тьма
    "свет_тьма": [
        ["попытался", "скрыться", "от", "света"],
        ["попыталась", "скрыться", "от", "света"],
        ["спрятался", "от", "сияния"],
        ["спряталась", "от", "сияния"],
        ["отверг", "свет"],
        ["отвергла", "свет"],
    ],
    # Пространство свет
    "пространство_свет": [
        ["доверился", "интуиции", "и", "вошёл", "в", "невозможную", "комнату"],
        ["доверилась", "интуиции", "и", "вошла", "в", "невозможную", "комнату"],
        ["нашёл", "дверь", "в", "невозможное", "место"],
        ["нашла", "дверь", "в", "невозможное", "место"],
        ["прошёл", "через", "невозможный", "проход"],
        ["прошла", "через", "невозможный", "проход"],
    ],
    # Пространство тьма
    "пространство_тьма": [
        ["разрушал", "стены", "чтобы", "выйти"],
        ["разрушала", "стены", "чтобы", "выйти"],
        ["ломал", "пространство", "силой"],
        ["ломала", "пространство", "силой"],
        ["пробил", "себе", "путь"],
        ["пробила", "себе", "путь"],
    ],
    # Душа свет
    "душа_свет": [
        ["воскресил", "душу", "из", "любви"],
        ["воскресила", "душу", "из", "любви"],
        ["вернул", "к", "жизни", "любимого"],
        ["вернула", "к", "жизни", "любимого"],
        ["оживил", "из", "сострадания"],
        ["оживила", "из", "сострадания"],
    ],
    # Душа тьма
    "душа_тьма": [
        ["воскресил", "душу", "ради", "выгоды"],
        ["воскресила", "душу", "ради", "выгоды"],
        ["вернул", "к", "жизни", "для", "пользы"],
        ["вернула", "к", "жизни", "для", "пользы"],
        ["оживил", "из", "корысти"],
        ["оживила", "из", "корысти"],
    ],
    # Хаос свет
    "хаос_свет": [
        ["принял", "результат", "колеса", "каким", "бы", "он", "ни", "был"],
        ["приняла", "результат", "колеса", "каким", "бы", "он", "ни", "был"],
        ["смирился", "с", "исходом", "испытания"],
        ["смирилась", "с", "исходом", "испытания"],
        ["не", "стал", "спорить", "с", "судьбой"],
        ["не", "стала", "спорить", "с", "судьбой"],
    ],
    # Хаос тьма
    "хаос_тьма": [
        ["попытался", "обмануть", "колесо", "фортуны"],
        ["попыталась", "обмануть", "колесо", "фортуны"],
        ["схитрил", "в", "испытании", "хаоса"],
        ["схитрила", "в", "испытании", "хаоса"],
        ["обманул", "случайность"],
        ["обманула", "случайность"],
    ],
    # Звук свет
    "звук_свет": [
        ["нашёл", "гармонию", "в", "хаосе", "звуков"],
        ["нашла", "гармонию", "в", "хаосе", "звуков"],
        ["услышал", "музыку", "сфер"],
        ["услышала", "музыку", "сфер"],
        ["слился", "с", "мировой", "мелодией"],
        ["слилась", "с", "мировой", "мелодией"],
    ],
    # Звук тьма
    "звук_тьма": [
        ["заглушил", "все", "звуки", "вокруг"],
        ["заглушила", "все", "звуки", "вокруг"],
        ["заставил", "мир", "замолчать"],
        ["заставила", "мир", "замолчать"],
        ["создал", "абсолютную", "тишину"],
        ["создала", "абсолютную", "тишину"],
    ],
    # Разум свет
    "разум_свет": [
        ["задал", "один", "вопрос", "и", "ушёл", "из", "библиотеки"],
        ["задала", "один", "вопрос", "и", "ушла", "из", "библиотеки"],
        ["ограничился", "одним", "знанием"],
        ["не", "стал", "жадничать", "в", "поиске", "истины"],
        ["не", "стала", "жадничать", "в", "поиске", "истины"],
    ],
    # Разум тьма
    "разум_тьма": [
        ["попытался", "узнать", "всё", "и", "потерял", "себя"],
        ["попыталась", "узнать", "всё", "и", "потеряла", "себя"],
        ["прочитал", "слишком", "много"],
        ["прочитала", "слишком", "много"],
        ["утратил", "себя", "в", "знаниях"],
        ["утратила", "себя", "в", "знаниях"],
    ],
    # Равновесие свет
    "равновесие_свет": [
        ["признал", "равновесие", "света", "и", "тьмы", "в", "себе"],
        ["признала", "равновесие", "света", "и", "тьмы", "в", "себе"],
        ["принял", "обе", "стороны", "своей", "души"],
        ["приняла", "обе", "стороны", "своей", "души"],
        ["осознал", "свой", "баланс"],
        ["осознала", "свой", "баланс"],
    ],
    # Равновесие тьма
    "равновесие_тьма": [
        ["попытался", "обмануть", "весы"],
        ["попыталась", "обмануть", "весы"],
        ["солгал", "о", "своём", "балансе"],
        ["солгала", "о", "своём", "балансе"],
        ["скрыл", "свою", "истинную", "природу"],
        ["скрыла", "свою", "истинную", "природу"],
    ],
}

# ===== ОПИСАНИЯ ВЕТВЕЙ (как в прошлом варианте) =====
BRANCH_DESCRIPTIONS = {
    "плоть_свет": "**Путь Целителя**: вы обрели гармонию со своим телом. Теперь вы можете исцелять раны, восстанавливать утраченные органы и даже замедлять старение. Ваше тело — храм, и вы его бережёте.",
    "плоть_тьма": "**Путь Разрушителя**: вы превратили плоть в оружие. Вы способны усиливать себя до чудовищных пределов, разрушать плоть врагов касанием и принимать гибридные формы. Но с каждым превращением вы теряете человечность.",
    "материя_свет": "**Путь Творца**: вы создаёте артефакты с чистыми намерениями. Ваши творения служат защите и созиданию. Вы можете превращать камень в металл, а мечту — в реальность.",
    "материя_тьма": "**Путь Воина Материи**: вы используете материю для разрушения. Ваше оружие не знает пощады, а вражеские доспехи рассыпаются в прах. Но созидание становится для вас чуждым.",
    "время_свет": "**Путь Хроникёра**: вы наблюдаете время, не вмешиваясь. Вы можете замедлять его, видеть прошлое и заглядывать в грядущее. Ваша мудрость — ваша сила.",
    "время_тьма": "**Путь Разрушителя Времени**: вы ускоряете и старите, вырываете мгновения из жизни врагов. Но каждое вмешательство оставляет на вас временную рану.",
    "сны_свет": "**Путь Мечтателя**: вы приняли свои страхи и научились создавать светлые иллюзии, лечить душевные раны и дарить надежду. Ваши сны становятся явью, не разрушая реальность.",
    "сны_тьма": "**Путь Кошмара**: вы вселяете ужас, управляете страхами и крадёте сны. Но ваши собственные кошмары теперь всегда с вами.",
    "оковы_свет": "**Путь Стража**: вы защищаете. Ваши барьеры нерушимы, а союзники под вашей опекой неуязвимы. Вы — щит, за которым можно укрыться.",
    "оковы_тьма": "**Путь Тюремщика**: вы сковываете и подавляете. Воля врагов ломается под вашим взглядом, а магия затихает. Но цепи, что вы куёте, сковывают и вас.",
    "тень_свет": "**Путь Целостного**: вы приняли свою тень и слились с ней. Теперь вы свободно перемещаетесь между мирами, а ваша тень — ваш верный союзник.",
    "тень_тьма": "**Путь Поглощённого**: вы отвергли тень и пытались её уничтожить, но она поглощает вас изнутри. Вы обрели огромную силу, но с каждым днём теряете себя.",
    "свет_свет": "**Путь Провидца**: вы признали свои грехи и стали чистым проводником истины. Вы видите ложь, пророчите будущее и испепеляете тьму. Но свет внутри вас требует честности всегда.",
    "свет_тьма": "**Путь Ослепительного**: вы попытались спрятаться от света, но он выжег вам глаза. Вы ослепли физически, но обрели внутреннее зрение. Ваш свет стал чёрным и сеет слепоту среди врагов.",
    "пространство_свет": "**Путь Мандра**: вы доверились интуиции и научились находить дорогу в любых лабиринтах. Вы телепортируетесь, создаёте порталы и всегда знаете, где выход.",
    "пространство_тьма": "**Путь Исказителя**: вы разрушали пространство, чтобы вырваться. Теперь вы можете сжимать и разрывать его, ловить врагов в бесконечные коридоры. Но каждый раз, искажая реальность, вы искажаете и себя.",
    "душа_свет": "**Путь Пастыря**: вы воскресили душу из чистой любви. Теперь вы провожаете мёртвых, исцеляете душевные раны и можете просить духов о помощи. Они слышат вас.",
    "душа_тьма": "**Путь Некроманта**: вы вернули душу ради выгоды и привязали её к себе. Теперь вы повелеваете мёртвыми, но ваша собственная душа постепенно чернеет и тяжелеет.",
    "хаос_свет": "**Путь Игрока**: вы приняли результат, какой бы он ни был. Теперь вы умеете влиять на удачу, не теряя контроля. Ваше везение — ваша воля.",
    "хаос_тьма": "**Путь Отчаянного**: вы попытались обмануть хаос, и он исказил вас. Вы стали живым воплощением непредсказуемости, но ваша сила всегда бьёт и по вам самим.",
    "звук_свет": "**Путь Гармониста**: вы нашли мелодию среди хаоса. Вы исцеляете звуком, успокаиваете бури и создаёте музыку, что трогает души. Мир звучит для вас в унисон.",
    "звук_тьма": "**Путь Какофониста**: вы заставили мир замолчать. Вы разрушаете резонансом, крик ваш убивает, а тишина становится оружием. Но вы больше не слышите ничего, кроме собственной пустоты.",
    "разум_свет": "**Путь Мудреца**: вы задали один вопрос и сохранили себя. Вы читаете мысли, двигаете предметы и общаетесь ментально. Ваш разум ясен, как горное озеро.",
    "разум_тьма": "**Путь Властелина**: вы попытались объять необъятное и потеряли часть себя. Вы подчиняете волю других, но в вашей голове звучат голоса всех, кем вы управляли.",
    "равновесие_свет": "**Путь Миротворца**: вы приняли равновесие света и тьмы в себе. Вы восстанавливаете гармонию, уравниваете силы и дарите покой. Вы сами — воплощение баланса.",
    "равновесие_тьма": "**Путь Вершителя**: вы попытались обмануть весы и теперь принудительно уравниваете всех вокруг. Вы забираете у сильных и отдаёте слабым, но ваша собственная душа никогда не знает покоя.",
}

# ===== ЛОГГИРОВАНИЕ =====
logging.basicConfig(format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO)
logger = logging.getLogger(__name__)

# ===== ПОИСК ВЕТВИ ПО КЛЮЧЕВЫМ СЛОВАМ (ПО ВАРИАНТАМ) =====
def find_branch_by_text(text):
    words = set(text.lower().split())  # множество слов сообщения
    for branch_key, variants in CONDITIONS.items():
        for variant in variants:
            # Проверяем, что все слова варианта присутствуют в сообщении
            if all(word in words for word in variant):
                return branch_key
    return None

# ===== ОБРАБОТЧИКИ =====
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await update.message.reply_text(
        "Привет, искатель! Я помогу тебе отслеживать разблокировку ветвей магии.\n"
        "Когда выполнишь условие, напиши мне сообщение, описывающее твой подвиг. "
        "Я сам пойму, какую ветвь ты разблокировал."
    )

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await update.message.reply_text(
        "Этот бот записывает, какие ветви магии ты разблокировал в ролевой игре.\n"
        "Когда совершаешь выбор в испытании, просто опиши его своими словами — "
        "я найду ключевые слова и засчитаю нужную ветвь.\n"
        "Например, если ты обнял своё отражение, напиши что-то вроде 'я обнял своё отражение в лабиринте'."
    )

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_user.id
    text = update.message.text.lower().strip()
    if not text:
        return

    unlocked = get_user_branches(user_id)
    branch_key = find_branch_by_text(text)

    if branch_key:
        if branch_key in unlocked:
            await update.message.reply_text("Ты уже получил(а) эту ветвь магии. Иди дальше, искатель!")
        else:
            unlocked.add(branch_key)
            save_user_branches(user_id, unlocked)
            description = BRANCH_DESCRIPTIONS.get(branch_key, "Описание отсутствует.")
            await update.message.reply_text(
                f"Поздравляю! Ты выполнил(а) условие и разблокировал(а) новую ветвь магии.\n\n{description}"
            )
    # Если ничего не найдено — игнорируем

# ===== ЗАПУСК =====
def main():
    init_db()
    app = Application.builder().token(TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("help", help_command))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    logger.info("Бот запущен...")
    app.run_polling()

if __name__ == "__main__":
    main()